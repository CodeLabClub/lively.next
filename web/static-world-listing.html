<!DOCTYPE html>
<html>
  <head>
    <title>lively.next worlds</title>
    <style>
    .body {
      width: 100%
    }
    .content {
      font-family: Helvetica Neue, Verdana, sans-serif;
      margin-left: auto;
      margin-right: auto;
      width: 70%;
      /*max-width: 800px;*/
    }

    .world-preview {
      position: relative;
      display: inline-block;
      margin: 5px;
      border: 2px #d4d4d4;
      border-radius: 8px;
      box-sizing: border-box;
      border-style: solid;
    }

    .image-title {
      position: absolute;
      bottom: 0;
      width: 100%
    }

    .list {
      display: flex;
      justify-content: space-around;
      flex-flow: wrap;
    }

    .user-flap {
      position: fixed;
      right: 10px;
      top: 0;
      background: rgba(255, 255, 255, 0.5);
      height: 30px;
      border-style: solid;
      border-width: 0px 1px 1px;
      border-color: rgb(255, 255, 255) rgb(204, 204, 204) rgb(204, 204, 204);
      border-radius: 0px 0px 8px 8px;
      cursor: pointer;      
    }

    .user-flap .label {
      pointer-events: none;
      font-family: sans-serif;
      font-size: 12px;
      font-famliy: Helvetica Neue, Verdana, Sans Serif;
      font-weight: bold;
      color: rgb(102, 102, 102);
      padding: 4px;
    }
    </style>
  </head>

  <body style="margin: 0;">

    <div id="dom-loading-indicator"
         style="position: fixed; top: 50%; left: 50%;
                margin-left: -160px; margin-top: -90px; z-index: 10;">
      <div style="width: 320px; height: 180px; font-size: 30pt; border-radius: 10px;
                  color: #ff7700; font-family: Helvetica Neue, Arial, sans-serif;
                  padding: 10px; background: #666;">
         <center><b>Loading</b></center>
         <div style="background-image: url(/lively.morphic/lively-web-logo-small-animate.svg);
                     background-size: cover; height: 100%; margin-left: 110px; margin-top: 20px;"></div>
      </div>
    </div>

    
    <div class="user-flap"><div class="label"><span></span></div></div>

    <div class="content">
      <div class="public-worlds">
        <center><h1>public worlds</h1></center>
        <div class="list">none yet</div>
      </div>
      <div class="local-worlds">
        <center><h1>your worlds</h1></center>
        <div class="list">none yet</div>
      </div>
    </div>

    <script src="/lively.next-node_modules/babel-standalone/babel.js"></script>
    <script src="/lively.next-node_modules/systemjs/dist/system.src.js"></script>
    <script src="/lively.modules/dist/lively.modules.js"></script>
    <script src="/lively.storage/dist/lively.storage_with-pouch.js"></script>
    <script src="/lively.user/dist/lively.user-client.js"></script>

    <script src="/lively.2lively/dist/lively.2lively_client.js"></script>
    <script>
      lively.l2l.client = lively.l2l.L2LClient.ensure({
        url: `${document.location.origin}/lively-socket.io`,
        namespace: "l2l", info: {type: "world-listing"}
      });
    </script>

    <script>
      var res = lively.resources.resource,
          loc = document.location,
          origin = loc.origin,
          query = res(loc.href).query(),
          loginDone = false,
          userRegistry = lively.user.UserRegistry.current,
          userFlap = document.querySelector(".user-flap"),
          userFlapContent = document.querySelector(".user-flap span"),
          user = currentUser();

      if (loc.host !== "lively-next.org")
        document.title = `lively.next (${loc.host})`;

      {
        userFlapContent.textContent = user.name.startsWith("guest-") ? "guest" : user.name;
        userFlap.onclick = evt => {
          document.location = res(loc.href).withQuery({login: true}).url;
        }
      }

      if (!userRegistry.hasUserStored() || query.login) {
        res(`${origin}/lively.user/html/html-ui.fragment`).read()
          .then(function(content) {
            document.body.insertAdjacentHTML("beforeend", content);
            return lively.resources.loadViaScript("/lively.user/html/html-ui.js");
          })
          .then(function() { return lively.user.html.openUserUI(); })
          .then(function(_user) {
            user = _user;
            userFlapContent.textContent = user.name.startsWith("guest-") ? "guest" : user.name;
            loginDone = true;
          })
          .catch(function(err) { console.error(err); });
      } else loginDone = true;

      polyfills()
        .then(function() { return res(origin).join("package-registry.json").readJson(); })
        .then(function(packageCached) {
          var System = lively.modules.getSystem("listing", {baseURL: String(origin)});
          lively.modules.changeSystem(System, true);
          System["__lively.modules__packageRegistry"] = lively.modules.PackageRegistry.fromJSON(System, packageCached);
        })
        .then(function() { return lively.modules.registerPackage("lively.morphic"); })
        .then(function() { return lively.modules.module("lively.morphic/web/static-world-listing.js").load(); })
        .then(function(m) { return m.run(); })
        .catch(function(err) { console.error(err); });

      function currentUser() {
        return userRegistry.loadUserFromLocalStorage("https://auth.lively-next.org"/*FIXME!!!*/);
      }

      function polyfills() {
        var loads = [];
        if (!("PointerEvent" in window))
          loads.push(lively.resources.loadViaScript(`${origin}/lively.next-node_modules/pepjs/dist/pep.js`));
        if (!("fetch" in window))
          loads.push(lively.resources.loadViaScript(`//cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.js`));
        return Promise.all(loads);
      }
    </script>

  </body>
</html>
